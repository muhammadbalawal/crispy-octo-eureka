<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excalidraw - Draw with AI</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { convertPromptToElements } from './backboard-client.js';
    import { WidgetLoader } from './widget-loader.js';

    // Minimal UI matching excalidraw-mcp-app with input
    const root = document.getElementById('root');
    root.innerHTML = `
      <main class="main">
        <div class="prompt-bar">
          <input type="text" id="prompt-input" placeholder="What would you like to draw?" />
          <button id="draw-btn">Draw</button>
        </div>
        <div class="toolbar">
          <button class="fullscreen-btn" title="Enter fullscreen">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5">
              <path d="M2 5V2h3M11 2h3v3M14 11v3h-3M5 14H2v-3" />
            </svg>
          </button>
        </div>
        <div id="widget-container" class="excalidraw-container"></div>
      </main>
    `;

    const widgetContainer = document.getElementById('widget-container');
    const fullscreenBtn = document.querySelector('.fullscreen-btn');
    const main = document.querySelector('.main');
    const promptInput = document.getElementById('prompt-input');
    const drawBtn = document.getElementById('draw-btn');
    let widgetLoader = null;
    let isFullscreen = false;

    // Fullscreen toggle
    fullscreenBtn.addEventListener('click', () => {
      if (!isFullscreen) {
        main.classList.add('fullscreen');
        isFullscreen = true;
        fullscreenBtn.style.display = 'none';
      }
    });

    // Exit fullscreen on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isFullscreen) {
        main.classList.remove('fullscreen');
        isFullscreen = false;
        fullscreenBtn.style.display = 'flex';
      }
    });

    // Load widget
    async function loadWidget() {
      if (widgetLoader) return widgetLoader;
      
      // Debug dimensions before loading
      const container = document.getElementById('widget-container');
      console.log('Container before load:', container.offsetWidth, 'x', container.offsetHeight);
      
      widgetLoader = new WidgetLoader('widget-container');
      await widgetLoader.load();
      
      // Debug dimensions after loading
      const iframe = document.getElementById('excalidraw-widget');
      console.log('Iframe after load:', iframe?.offsetWidth, 'x', iframe?.offsetHeight);
      
      return widgetLoader;
    }

    // Prompt function - exposed globally
    window.drawDiagram = async function(prompt) {
      if (!prompt) {
        prompt = promptInput.value.trim();
        if (!prompt) {
          alert('Please enter a prompt');
          return;
        }
      }

      try {
        drawBtn.disabled = true;
        drawBtn.textContent = 'Drawing...';
        console.log(`Drawing diagram: ${prompt}`);
        const elements = await convertPromptToElements(prompt);
        console.log(`Got ${elements.length} elements`);
        const loader = await loadWidget();
        await loader.callCreateView(elements);
        console.log('âœ“ Diagram rendered!');
        drawBtn.textContent = 'Draw';
        drawBtn.disabled = false;
      } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
        drawBtn.textContent = 'Draw';
        drawBtn.disabled = false;
      }
    };

    // Button click
    drawBtn.addEventListener('click', () => window.drawDiagram());

    // Enter key
    promptInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        window.drawDiagram();
      }
    });

    // Check for prompt in URL or start with default
    const urlParams = new URLSearchParams(window.location.search);
    const prompt = urlParams.get('prompt');
    
    if (prompt) {
      window.drawDiagram(prompt);
    } else {
      // Load widget on page load
      loadWidget().catch(console.error);
    }

    // Also allow prompt input via browser console
    console.log('Use drawDiagram("your prompt") to draw something!');
  </script>
</body>
</html>
